<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9, user-scalable=no">
    <title>Avanti Ledger | Inventory</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3f72af">

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js")
        .then(reg => console.log("Service worker registered:", reg))
        .catch(err => console.error("Service worker error:", err));
    });
  }
</script>

<!-- iOS icon -->
<link rel="apple-touch-icon" href="https://ik.imagekit.io/3mtmeexff/IMG_0905.jpeg?updatedAt=1764942582222">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE INITIALIZATION ---
        const firebaseConfig = {
            // NOTE: The apiKey is omitted here for security best practice, 
            // but must be present for a real deployment.
            // apiKey: "AIzaSyAw7L6TJtF1W0PwfStEJUC4CebUyMdQU9w", 
            authDomain: "users-66be4.firebaseapp.com",
            databaseURL: "https://users-66be4-default-rtdb.firebaseio.com",
            projectId: "users-66be4",
            storageBucket: "users-66be4.firebasestorage.app",
            messagingSenderId: "776585122050",
            appId: "1:776585122050:web:3f452a1f16dc36ee1ef21b",
            measurementId: "G-ZS8W4BBGD5"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();


        // --- ICON SYSTEM (Inline SVGs for Zero Dependency) ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                <g dangerouslySetInnerHTML={{ __html: path }} />
            </svg>
        );

        const Icons = {
            Package: (props) => <Icon path='<line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line>' {...props} />,
            Activity: (props) => <Icon path='<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>' {...props} />,
            ChevronRight: (props) => <Icon path='<polyline points="9 18 15 12 9 6"></polyline>' {...props} />,
            X: (props) => <Icon path='<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>' {...props} />,
            Sparkles: (props) => <Icon path='<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>' {...props} />,
            CreditCard: (props) => <Icon path='<rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line>' {...props} />,
            AlertCircle: (props) => <Icon path='<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>' {...props} />,
            TrendingUp: (props) => <Icon path='<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>' {...props} />,
            Calendar: (props) => <Icon path='<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>' {...props} />,
            Box: (props) => <Icon path='<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line>' {...props} />,
            Search: (props) => <Icon path='<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>' {...props} />,
            ChevronLeft: (props) => <Icon path='<polyline points="15 18 9 12 15 6"></polyline>' {...props} />,
            ChevronDown: (props) => <Icon path='<polyline points="6 9 12 15 18 9"></polyline>' {...props} />,
        };

        // --- UTILS & FORMATTING ---
        
        const formatCurrency = (amount) => {
            if (amount === null || amount === undefined || isNaN(amount)) return 'N/A';
            return `K${Math.round(amount).toLocaleString('en-US')}`;
        };
        
        const formatTotalUnits = (units) => {
            if (units === null || units === undefined || isNaN(units)) return '0';
            return new Intl.NumberFormat('en-US').format(units);
        };
        
        // Helper to format date keys (YYYY-MM-DD) to readable format
        const formatDateKey = (dateKey) => {
            if (!dateKey || dateKey === 'N/A') return 'N/A';
            const [year, month, day] = dateKey.split('-');
            // IMPORTANT: Month in Date constructor is 0-indexed (month - 1)
            const date = new Date(year, month - 1, day); 
            return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
        };
        
        // Helper to format date objects or keys to Month Year (e.g., Dec 2025) for display
        const formatToMonthYear = (date) => {
            if (typeof date === 'string') {
                const [year, month] = date.split('-');
                date = new Date(year, month - 1, 1);
            }
            if (!date || date === 'N/A') return 'N/A';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        };

        /** * Returns a Date object set to the 1st day of the current month.
         */
        const getCurrentMonthDate = () => {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), 1); 
        };
        
        // Helper to calculate the week's date range (e.g., 7 Dec - 13 Dec)
        const getWeekRange = (dateKey) => {
            const [year, month, day] = dateKey.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            
            // Get the day of the week (0 for Sunday, 1 for Monday, etc.)
            const dayOfWeek = date.getDay(); 
            // Calculate the difference to Monday (start of the week)
            // Monday is day 1. (dayOfWeek - 1 + 7) % 7 calculates days to subtract.
            const daysToSubtract = (dayOfWeek === 0 ? 6 : dayOfWeek - 1); 

            // Start of the week (Monday)
            const startDate = new Date(date);
            startDate.setDate(date.getDate() - daysToSubtract);

            // End of the week (Sunday)
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            const options = { day: 'numeric', month: 'short' };
            const startStr = startDate.toLocaleDateString('en-US', options);
            const endStr = endDate.toLocaleDateString('en-US', options);

            return `${startStr} - ${endStr}`;
        };

        const groupPurchasesByWeek = (purchases) => {
            const grouped = {};
            purchases.forEach(p => {
                // p.id is expected to be 'YYYY-MM-DD-itemId'
                const originalDateKey = p.id.split('-').slice(0, 3).join('-');

                const weekKey = getWeekRange(originalDateKey);

                if (!grouped[weekKey]) {
                    // Create Date object for sorting based on YYYY-MM-DD format
                    const [year, month, day] = originalDateKey.split('-').map(Number);
                    
                    grouped[weekKey] = {
                        week: weekKey,
                        purchases: [],
                        totalUnits: 0,
                        totalValue: 0,
                        // Use the start date for sorting weeks chronologically
                        startDate: new Date(year, month - 1, day) 
                    };
                }
                grouped[weekKey].purchases.push(p);
                grouped[weekKey].totalUnits += p.quantity;
                grouped[weekKey].totalValue += p.costValue;
            });

            // Sort weeks chronologically
            const sortedKeys = Object.keys(grouped).sort((keyA, keyB) => {
                return grouped[keyA].startDate - grouped[keyB].startDate;
            });

            return sortedKeys.map(key => grouped[key]);
        };
        
        // This function is no longer strictly necessary but kept for data consistency
        const generateFullPeriodList = (oldestDateKey) => {
            if (!oldestDateKey) return [formatToMonthYear(getCurrentMonthDate())];
            
            const [startYear, startMonth] = oldestDateKey.split('-').map(Number);
            
            const today = new Date();
            const endDate = new Date(today.getFullYear() + 1, today.getMonth(), 1); // Up to 1 year in the future
            const startDate = new Date(startYear, startMonth - 1, 1);
            
            let current = new Date(startDate);
            const periods = [];

            while (current <= endDate) {
                periods.push(formatToMonthYear(current));
                current.setMonth(current.getMonth() + 1);
            }

            return Array.from(new Set(periods)).sort((a, b) => new Date(b) - new Date(a));
        };


        // --- FIREBASE DATA FETCHING HOOK ---

        function useInventoryData() {
            const [accountName, setAccountName] = useState(null);
            const [username, setUsername] = useState(null);
            const [data, setData] = useState({
                items: [],
                purchases: [],
                empties: [],
                periodList: [], 
                purchasePeriods: new Set(), // Store only the periods that actually have data
                totalStockUnits: 0,
                totalExpectedRevenue: 0,
                totalEmptiesUnits: 0,
                totalPurchasedUnits: 0,
                totalPurchasedValue: 0,
                gfaSetting: true, 
                inventoryDate: null,
                isLoading: true,
                error: null,
            });
            
            // Function to delete the obsolete empties_tracking item
            const deleteEmptyBottleItem = useCallback((targetPath, itemId) => {
                const itemRef = db.ref(`${targetPath}/${itemId}`);
                
                // Realtime Database remove() operation
                itemRef.remove()
                    .then(() => {
                        console.log(`Successfully deleted obsolete empties item: ${itemId} from ${targetPath}`);
                    })
                    .catch((error) => {
                        console.error(`Failed to delete obsolete empties item ${itemId}:`, error);
                    });
            }, []);

            const getTargetProfile = useCallback(async (accName, user) => {
                const syncSnap = await db.ref(`accounts/${accName}/profiles/${user}/syncingWith`).once('value');
                const syncingWith = syncSnap.val();
                
                if (syncingWith) {
                    const syncedUser = Object.keys(syncingWith).find(key => syncingWith[key] === true);
                    if (syncedUser) {
                        return { user: syncedUser, path: `accounts/${accName}/profiles/${syncedUser}` };
                    }
                }
                return { user, path: `accounts/${accName}/profiles/${user}` };
            }, []);

            const getGfaSetting = useCallback(async (accName, targetUser) => {
                let gfaEnabled = true;
                const userGfaRef = db.ref(`accounts/${accName}/settings/${targetUser}/GFA`);
                let userGfaSnap = await userGfaRef.once('value');
                if (userGfaSnap.exists() && userGfaSnap.val() === false) {
                    gfaEnabled = false;
                }
                const globalSyncSnap = await db.ref(`accounts/${accName}/settings/synchronization`).once('value');
                const synchronization = globalSyncSnap.val();

                if (synchronization === 'all') {
                    const globalGfaRef = db.ref(`accounts/${accName}/settings/global_ledger/GFA`);
                    let globalGfaSnap = await globalGfaRef.once('value');
                    
                    if (globalGfaSnap.exists() && globalGfaSnap.val() === true) {
                        gfaEnabled = true;
                    }
                }
                return gfaEnabled; 
            }, []);

            const getBasePaths = useCallback(async (accName, targetUser) => {
                const syncAllSnap = await db.ref(`accounts/${accName}/settings/synchronization`).once('value');
                const synchronization = syncAllSnap.val();
                
                if (synchronization === 'all') {
                    return {
                        statsPath: `accounts/${accName}/global_ledger/avanti_stats/dates`,
                        emptiesPath: `accounts/${accName}/global_ledger/empties_tracking`,
                    };
                } else {
                    return {
                        statsPath: `accounts/${accName}/profiles/${targetUser}/avanti_stats/dates`,
                        emptiesPath: `accounts/${accName}/profiles/${targetUser}/empties_tracking`,
                    };
                }
            }, []);


            const fetchData = useCallback(async (accName, user) => {
                if (!accName || !user) {
                    setData(d => ({ ...d, isLoading: false, error: "Account or username not found in local storage." }));
                    return;
                }

                try {
                    // 1. Determine Target User & Paths
                    const { user: targetUser } = await getTargetProfile(accName, user);
                    const gfaEnabled = await getGfaSetting(accName, targetUser);
                    const { statsPath, emptiesPath } = await getBasePaths(accName, targetUser);

                    // 2. Fetch All Stats Data
                    const statsSnap = await db.ref(statsPath).once('value');
                    const datesData = statsSnap.val() || {};
                    const datesKeys = Object.keys(datesData).sort(); // YYYY-MM-DD sorted ascending
                    
                    // Determine the oldest data date for full period list generation
                    const oldestDateKey = datesKeys.length > 0 ? datesKeys[0] : null;

                    // 3. Find Inventory As At Date (Balanced or Latest)
                    let inventoryDate = null;
                    let inventoryItems = {};
                    
                    for (let i = datesKeys.length - 1; i >= 0; i--) {
                        const dateKey = datesKeys[i];
                        
                        if (datesData[dateKey].balanced === true) {
                            inventoryDate = dateKey;
                            inventoryItems = datesData[dateKey].items || {};
                            break;
                        }
                    }

                    if (!inventoryDate && datesKeys.length > 0) {
                        const latestDateKey = datesKeys[datesKeys.length - 1];
                        inventoryDate = latestDateKey;
                        const lastDayItems = datesData[latestDateKey].items || {};
                        inventoryItems = Object.entries(lastDayItems).reduce((acc, [itemId, data]) => {
                            acc[itemId] = { ...data, closing: data.closing || 0 }; 
                            return acc;
                        }, {});
                    }

                    // 4. Process Inventory Items & Purchase Data
                    const finalItems = [];
                    const purchaseDataByPeriod = {}; 
                    const purchasePeriods = new Set(); // To track periods with actual purchases
                    let totalStockUnits = 0;
                    let totalExpectedRevenue = 0;
                    let totalPurchasedUnits = 0;
                    let totalPurchasedValue = 0;
                    
                    const itemDataMap = {}; 

                    Object.entries(inventoryItems).forEach(([itemId, data]) => {
                        const stock = data.closing || 0; 
                        const price = data.price || 0;
                        const costPrice = data.lastOrderCost || 0;
                        // Use the name from the inventory item map, falling back to a generic ID if name is missing
                        const name = data.name || `Item ${itemId}`; 

                        totalStockUnits += stock;
                        totalExpectedRevenue += stock * price;
                        
                        finalItems.push({
                            id: itemId,
                            name: name,
                            stock: stock,
                            price: price,
                            costPrice: costPrice,
                            status: stock > 0 ? "Healthy" : "Low",
                        });
                        // CRITICAL: Populate itemDataMap correctly with the name, price, and costPrice
                        itemDataMap[itemId] = { name: name, price, costPrice };
                    });


                    // Process Purchases from all dates
                    for (const dateKey of datesKeys) {
                        const dayData = datesData[dateKey].items || {};
                        const periodKey = formatToMonthYear(dateKey);

                        Object.entries(dayData).forEach(([itemId, data]) => {
                            const orders = data.orders || 0;
                            if (orders > 0) {
                                // Use itemDataMap lookup for name.
                                const itemInfo = itemDataMap[itemId] || { 
                                    name: data.name || `Item ${itemId}`, 
                                    price: data.price || 0, 
                                    costPrice: data.lastOrderCost || 0 
                                };

                                const purchaseCost = itemInfo.costPrice || 0; 
                                const purchasePrice = itemInfo.price || 0;
                                
                                const value = orders * (gfaEnabled ? purchaseCost : purchasePrice);
                                
                                totalPurchasedUnits += orders;
                                totalPurchasedValue += value;
                                purchasePeriods.add(periodKey); // Track month with data

                                if (!purchaseDataByPeriod[periodKey]) {
                                    purchaseDataByPeriod[periodKey] = {
                                        period: periodKey,
                                        purchases: [],
                                    };
                                }
                                purchaseDataByPeriod[periodKey].purchases.push({
                                    id: `${dateKey}-${itemId}`, 
                                    item: itemInfo.name, 
                                    date: formatDateKey(dateKey),
                                    quantity: orders,
                                    costValue: value, 
                                    periodKey: periodKey,
                                });
                            }
                        });
                    }

                    // 5. Fetch, Calculate, & Clean Empty Bottles
                    const emptiesSnap = await db.ref(emptiesPath).once('value');
                    const emptiesData = emptiesSnap.val() || {};
                    const finalEmpties = [];
                    let totalEmptiesUnits = 0;
                    
                    const emptiesPathBase = emptiesPath; // Base path for the delete function

                    Object.entries(emptiesData).forEach(([itemId, emptyItemData]) => {
                        
                        // *** NEW DATA CLEANUP LOGIC ***
                        // Check if the item ID from empties_tracking exists in the itemDataMap (from avanti_stats).
                        if (!itemDataMap[itemId] || !itemDataMap[itemId].name) {
                            console.warn(`Obsolete empties item found: ${itemId}. Deleting from database.`);
                            
                            // Delete the obsolete node from the database
                            deleteEmptyBottleItem(emptiesPathBase, itemId);
                            
                            // Skip processing this item further in the frontend
                            return; 
                        }
                        // *** END NEW DATA CLEANUP LOGIC ***

                        const initialCount = emptyItemData.initialCount || 0;
                        const startDateKey = emptyItemData.startDate;
                        if (!startDateKey) return; 

                        let emptiesCount = initialCount;
                        
                        datesKeys.forEach(dateKey => {
                            if (dateKey >= startDateKey) {
                                const dayData = datesData[dateKey].items && datesData[dateKey].items[itemId];
                                if (dayData) {
                                    const opening = dayData.opening || 0;
                                    const orders = dayData.orders || 0;
                                    const closing = dayData.closing || 0;
                                    
                                    // Sales = opening + orders - closing
                                    const sales = opening + orders - closing;
                                    
                                    // Empties formula: initialCount + Σ(sales - orders)
                                    emptiesCount += (sales - orders);
                                }
                            }
                        });
                        
                        const units = Math.max(0, emptiesCount);
                        totalEmptiesUnits += units;

                        finalEmpties.push({
                            item: itemDataMap[itemId].name, // Safe to use map name here due to check above
                            units: units,
                        });
                    });

                    // We still calculate a period list, but the navigation won't use it for bounds
                    const fullPeriodList = generateFullPeriodList(oldestDateKey);


                    setData({
                        items: finalItems,
                        purchases: Object.values(purchaseDataByPeriod).flatMap(p => p.purchases), 
                        empties: finalEmpties,
                        periodList: fullPeriodList, 
                        purchasePeriods: purchasePeriods, // Pass periods that actually have purchases
                        totalStockUnits: totalStockUnits,
                        totalExpectedRevenue: totalExpectedRevenue,
                        totalEmptiesUnits: totalEmptiesUnits, 
                        totalPurchasedUnits: totalPurchasedUnits,
                        totalPurchasedValue: totalPurchasedValue,
                        gfaSetting: gfaEnabled,
                        inventoryDate: inventoryDate ? formatDateKey(inventoryDate) : 'N/A',
                        isLoading: false,
                        error: null,
                    });

                } catch (e) {
                    console.error("Firebase Data Fetch Error:", e);
                    setData(d => ({ ...d, isLoading: false, error: "Failed to load data from Firebase." }));
                }

            }, [getTargetProfile, getGfaSetting, getBasePaths, deleteEmptyBottleItem]); // Added deleteEmptyBottleItem dependency


            useEffect(() => {
                // 0. Load Local Storage
                const accKey = localStorage.getItem('AV_ledger_account_key');
                const userKey = localStorage.getItem('AV_ledger_username');
                
                setAccountName(accKey);
                setUsername(userKey);

                if (accKey && userKey) {
                    fetchData(accKey, userKey);
                } else {
                    setData(d => ({ ...d, isLoading: false, error: "Local storage keys (AV_ledger_account_key, AV_ledger_username) missing." }));
                }

            }, [fetchData]);

            return data;
        }


        // --- UI BLOCKS ---

        const Card = ({ children, className = "", onClick }) => (
            <div 
                onClick={onClick}
                className={`bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden ${onClick ? 'active:scale-95 transition-transform cursor-pointer' : ''} ${className}`}
            >
                {children}
            </div>
        );

        const ListItem = ({ title, value, sub, leftValue, icon: IconComponent, color = "bg-blue-100 text-blue-600", onClick, isLast }) => (
            <div 
                onClick={onClick}
                className={`flex items-center justify-between p-4 bg-white ${!isLast ? 'border-b border-gray-100' : ''} active:bg-gray-50 ${onClick ? 'cursor-pointer transition-colors' : ''}`}
            >
                <div className="flex items-center gap-3">
                    
                    {/* ICON AREA */}
                    {IconComponent && !leftValue && (
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${color}`}>
                            <IconComponent size={20} />
                        </div>
                    )}

                    {leftValue && (
                         <div className="text-right pr-2">
                            <span className="text-lg font-bold text-gray-900">{leftValue}</span>
                            <p className="text-xs text-gray-500 uppercase">units</p>
                        </div>
                    )}
                    <div>
                        <h4 className="font-semibold text-gray-900 text-sm">{title}</h4>
                        {sub && <p className="text-xs text-gray-500">{sub}</p>}
                    </div>
                </div>
                <div className="flex items-center gap-2">
                    {value && <span className="text-gray-900 font-medium text-sm">{value}</span>}
                    {onClick && <Icons.ChevronRight size={16} className="text-gray-300" />}
                </div>
            </div>
        );

        const ReportModal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 animate-fade-in">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClose} />
                    <div className="relative w-full max-w-lg h-[95vh] sm:h-[85vh] bg-gray-50 rounded-t-3xl sm:rounded-3xl shadow-2xl overflow-hidden flex flex-col transform transition-transform duration-300 ease-out animate-slide-up">
                        
                        {/* Drag Handle */}
                        <div className="w-full bg-[#3f72af] pt-3 pb-2 flex justify-center shrink-0" onClick={onClose}>
                            <div className="w-12 h-1.5 bg-gray-200 rounded-full" />
                        </div>

                        {/* Header */}
                        <div className="bg-[#3f72af] px-6 pb-4 border-b border-gray-100 flex justify-between items-center shrink-0 mt-[-1px]">
                            <h2 className="text-xl font-bold text-white">{title}</h2>
                            <button onClick={onClose} className="p-2 bg-[#3f72af] rounded-full hover:bg-gray-200">
                                <Icons.X size={20} className="text-white" />
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- REPORT SPECIFIC COMPONENTS ---

        const SearchBar = ({ searchTerm, setSearchTerm, placeholder = "Search inventory items..." }) => (
            <div className="mb-6">
                <div className="relative">
                    <Icons.Search size={20} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    <input
                        type="text"
                        placeholder={placeholder}
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full py-3 pl-10 pr-4 text-sm bg-gray-100 rounded-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                    />
                </div>
            </div>
        );
        
        // --- MONTH NAVIGATION COMPONENT ---
        const MonthNavigation = ({ currentDate, setCurrentDate }) => {
            
            // Format the current date object for display (e.g., "Dec 2025")
            const periodDisplay = formatToMonthYear(currentDate);

            const handlePrev = () => { 
                // Previous button moves to OLDER month (subtract 1 from month index)
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() - 1);
                setCurrentDate(newDate);
            };
            
            const handleNext = () => { 
                // Next button moves to NEWER month (add 1 to month index)
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + 1);
                setCurrentDate(newDate);
            };

            // No 'disabled' state needed, as navigation is continuous both ways
            return (
                <div className="flex justify-between items-center p-2 bg-white rounded-xl mb-6 shadow-sm border border-gray-100">
                    <button 
                        onClick={handlePrev}
                        className={`p-1 transition-colors text-gray-900 hover:text-blue-600 active:text-blue-700`}
                    >
                        <Icons.ChevronLeft size={24} />
                    </button>
                    <span className="text-lg font-bold text-gray-900 flex items-center gap-1">
                        <Icons.Calendar size={18} className="text-gray-500" />
                        {periodDisplay}
                    </span>
                    <button 
                        onClick={handleNext}
                        className={`p-1 transition-colors text-gray-900 hover:text-blue-600 active:text-blue-700`}
                    >
                        <Icons.ChevronRight size={24} />
                    </button>
                </div>
            );
        };
        
        // --- REPORT CONTENT COMPONENT ---
        const ReportContent = ({ reportId, data }) => {
            const { items, purchases, purchasePeriods, totalStockUnits, totalExpectedRevenue, totalEmptiesUnits, gfaSetting, inventoryDate, empties } = data; 
            
            // Default date is the first of the current real-world month
            const defaultDate = useMemo(() => getCurrentMonthDate(), []);
            
            // State now tracks the Date object for the 1st of the selected month
            const [currentDate, setCurrentDate] = useState(defaultDate); 
            
            // Calculate the string key for the currently selected period (e.g., "Dec 2025")
            const currentPeriodKey = useMemo(() => formatToMonthYear(currentDate), [currentDate]);
            
            const [searchTerm, setSearchTerm] = useState('');
            
            const filteredInventory = useMemo(() => {
                if (!searchTerm) return items;
                return items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [searchTerm, items]);
            
            const highestContributor = useMemo(() => {
                return items.reduce((highest, item) => {
                    const quantityPriceProduct = item.stock * item.price; 
                    if (quantityPriceProduct > highest.value) {
                        return { name: item.name, value: quantityPriceProduct, quantity: item.stock };
                    }
                    return highest;
                }, { name: items.length > 0 ? items[0].name : 'N/A', value: 0, quantity: 0 }); 
            }, [items]);
            
            // Filter purchases based on the calculated currentPeriodKey
            const filteredPurchases = useMemo(() => {
                if (reportId !== 'stock_change') return [];
                
                // Only show purchases if the current period matches the purchase period.
                return purchases.filter(p => p.periodKey === currentPeriodKey);
            }, [reportId, purchases, currentPeriodKey]);
            
            // Group filtered purchases by week
            const weeklyPurchases = useMemo(() => {
                return groupPurchasesByWeek(filteredPurchases);
            }, [filteredPurchases]);
            
            
            // Check if the selected month actually has data
            const hasDataForCurrentMonth = purchasePeriods.has(currentPeriodKey);
            const isFutureMonth = currentDate > defaultDate; // Check if the selected date is after the current real-world month
            

            switch(reportId) {
                
                // --- STOCK SUMMARY ---
                case 'stock_summary': 
                    return (
                        <div className="space-y-6">

                            <SearchBar searchTerm={searchTerm} setSearchTerm={setSearchTerm} />

                            <Card className="p-6 bg-gradient-to-br from-blue-700 to-indigo-800 text-white shadow-lg border-none">
                                <h4 className="text-blue-300 text-xs font-bold uppercase tracking-wider mb-4">
                                    Inventory Overview (Quantity Focus)
                                </h4>
                                
                                <div className="flex justify-between items-end mb-4">
                                    <div>
                                        <p className="text-sm font-light text-blue-200">Total Units in Stock</p>
                                        <p className="text-5xl font-extrabold">{formatTotalUnits(totalStockUnits)}</p>
                                    </div>
                                    <Icons.Package size={48} className="text-blue-300 opacity-80"/>
                                </div>
                                
                                <hr className="my-4 border-blue-600" />

                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span className="text-blue-300 block text-xs uppercase font-semibold">Expected Return</span>
                                        <span className="font-bold text-white text-lg">{formatCurrency(totalExpectedRevenue)}</span>
                                    </div>

                                    <div className="text-right">
                                        <span className="text-blue-300 block text-xs uppercase font-semibold">Highest Contributor</span>
                                        <span className="font-bold text-white text-lg">{highestContributor.quantity} Units</span>
                                        <p className="text-xs text-blue-200 truncate">{highestContributor.name}</p>
                                    </div>
                                </div>
                            </Card>

                            <Card className="overflow-hidden">
                                <div className="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Inventory as at {inventoryDate}
                                                                                                                                            </h3>
<span className="text-xs font-semibold text-gray-500 flex items-center gap-1">  ({filteredInventory.length} Items)</span>                                  
                                </div>

                                {filteredInventory.length > 0 ? (
                                    filteredInventory.map((item, index, arr) => (
                                        <ListItem 
                                            key={item.id}
                                            title={item.name} 
                                            sub={`selling at ${formatCurrency(item.price)} per unit`}
                                            leftValue={item.stock} 
                                            isLast={index === arr.length - 1}
                                            onClick={null} 
                                        />
                                    ))
                                ) : (
                                    <p className="p-4 text-center text-gray-500 text-sm">No items match your search term.</p>
                                )}
                            </Card>
                        </div>
                    );
                
                // --- STOCK CHANGE REPORT (ENHANCED) ---
                case 'stock_change':
                    const totalPeriodUnits = filteredPurchases.reduce((sum, p) => sum + p.quantity, 0);
                    const totalPeriodValue = filteredPurchases.reduce((sum, p) => sum + p.costValue, 0);
                    const purchaseLineItemCount = filteredPurchases.length;

                    return (
                        <div className="space-y-6">

                            {/* Month Navigation - Continuous and unbounded */}
                            <MonthNavigation 
                                currentDate={currentDate} 
                                setCurrentDate={setCurrentDate} 
                            />
                            
                            {/* Summary Cards */}
                            <div className="grid grid-cols-2 gap-4">
                                <Card className="p-4 bg-gradient-to-r from-emerald-500 to-green-600 text-white border-none shadow-md">
                                    <p className="text-emerald-200 text-xs font-bold uppercase tracking-wider">Inventory Changed</p>
                                    <div className="flex items-end mt-1">
                                        <p className="text-3xl font-black">{purchaseLineItemCount} times</p>
                                    </div>
                                    <div className="flex items-center text-xs mt-2 text-white/90">
                                        <Icons.CreditCard size={16} className="mr-1" />
                                        <span>Through Purchase</span>
                                    </div>
                                </Card>

                                <Card className="p-4 bg-white shadow-md">
                                    <p className="text-gray-500 text-xs font-bold uppercase tracking-wider">Total Units Added</p>
                                    <p className="text-3xl font-black text-gray-900 mt-1">{formatTotalUnits(totalPeriodUnits)}</p>
                                    <p className="text-sm text-gray-500 mt-2">
                                        Value: <span className="font-bold text-gray-700">{formatCurrency(totalPeriodValue)}</span> ({gfaSetting ? 'C.price' : 'S.price'})
                                    </p>
                                </Card>
                            </div>
                            
                            {/* Weekly Breakdown List */}
                            <h3 className="text-sm font-bold text-gray-700 uppercase tracking-wider mt-6 ml-1">
                                Purchases Breakdown: {currentPeriodKey}
                            </h3>
                            
                            {hasDataForCurrentMonth && weeklyPurchases.length > 0 ? weeklyPurchases.map((weekData, weekIndex) => (
                                <Card key={weekData.week} className="mb-4">
                                    <div className="bg-gray-100 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                                        <h4 className="text-xs font-bold text-gray-700 uppercase tracking-wider">{weekData.week}</h4>
                                        <div className="text-right">
                                            <span className="text-sm font-bold text-gray-900 block">{formatTotalUnits(weekData.totalUnits)} units</span>
                                            
                                        </div>
                                    </div>
                                    
                                    {/* Items within the week */}
                                    {weekData.purchases.map((item, itemIndex, arr) => (
                                        <div key={item.id} className={`flex justify-between items-center p-4 active:bg-gray-50 ${itemIndex === arr.length - 1 ? '' : 'border-b border-gray-100'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full flex items-center justify-center bg-pink-50 text-pink-600">
                                                    <Icons.Box size={18} />
                                                </div>
                                                <div>
                                                    <h4 className="font-semibold text-gray-900 text-sm">{item.item}</h4> 
                                                    <p className="text-xs text-gray-500">Order Date: {item.date}</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <span className="text-lg font-bold text-gray-900">{item.quantity}</span>
                                                <p className="text-[10px] text-gray-400">{formatCurrency(item.costValue)} value</p>
                                            </div>
                                        </div>
                                    ))}
                                </Card>
                            )) : (
                                <p className="p-4 text-center text-gray-500 text-sm bg-white rounded-xl shadow">
                                    {isFutureMonth ? 
                                        `The month of ${currentPeriodKey} is in the future. No purchases recorded yet.` :
                                        `No purchases were recorded for ${currentPeriodKey}.`
                                    }
                                </p>
                            )}
                        </div>
                    );

                // --- EMPTY BOTTLE TRACKING ---
                case 'empty_bottles': 
                    const totalEmpties = empties.reduce((sum, b) => sum + b.units, 0);

                    return (
                        <div className="space-y-6">
                            {/* TOP DISPLAY - Total Empties Quantity in Units */}
                            <Card className="p-6 bg-blue-600 text-white">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-blue-200 text-xs font-bold uppercase">Total Empties Quantity</p>
                                        <p className="text-4xl font-black mt-1">{formatTotalUnits(totalEmpties)}</p>
                                    </div>
                                    <Icons.AlertCircle size={40} className="text-blue-300 opacity-70" />
                                </div>
                                <p className="text-blue-200 text-sm mt-2">Formula: Initial Count + Σ(Sales - Orders)
</p>
                            </Card>
                            
                            {/* iOS CARD LIST - Item and Units of Empty Bottles */}
                            <Card className="overflow-hidden">
                                <div className="bg-gray-50 px-4 py-3 border-b border-gray-100">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Empty Bottle Breakdown</h3>
                                </div>
                                {empties.length > 0 ? empties.map((item, index, arr) => (
                                    <div key={item.item} className="flex justify-between items-center p-4 border-b border-gray-100 last:border-0">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-full flex items-center justify-center bg-cyan-100 text-cyan-600">
                                                <Icons.Box size={20} />
                                            </div>
                                            <h4 className="font-semibold text-gray-900 text-sm">{item.item}</h4> {/* Displaying by Name */}
                                        </div>
                                        <div className="text-right">
                                            <span className="text-lg font-bold text-gray-900">{item.units}</span>
                                            <p className="text-[10px] text-gray-400">empty units</p>
                                        </div>
                                    </div>
                                )) : (
                                    <p className="p-4 text-center text-gray-500 text-sm">No empties tracking data found.</p>
                                )}
                            </Card>
                        </div>
                    );

                default:
                    return <div className="p-10 text-center text-gray-400">Select an Inventory Report to view its details.</div>;
            }
        };


        // --- MAIN APPLICATION (Inventory Default) ---

        function AvantiLedger() {
            const [selectedCategory, setSelectedCategory] = useState('Inventory'); 
            const [modalOpen, setModalOpen] = useState(false);
            const [currentReport, setCurrentReport] = useState(null);
            
            // Fetch all required data
            const inventoryData = useInventoryData();
            const { totalStockUnits, totalExpectedRevenue, totalEmptiesUnits, gfaSetting, isLoading, error, items } = inventoryData;


            // Calculate highest contributor for the main screen
            const highestContributor = useMemo(() => {
                return items.reduce((highest, item) => {
                    const quantityPriceProduct = item.stock * item.price; 
                    if (quantityPriceProduct > highest.value) {
                        return { name: item.name, value: quantityPriceProduct, quantity: item.stock };
                    }
                    return highest;
                }, { name: items.length > 0 ? items[0].name : 'N/A', value: 0, quantity: 0 }); 
            }, [items]);
            
            // Ensure data is ready before listing reports
            const isReady = !isLoading && !error;


            const categories = useMemo(() => ({
                'Accounting': [],
                'Sales': [], 
                'Inventory': [
                    { id: 'stock_summary', title: 'Stock Summary', sub: `Inventory as at ${inventoryData.inventoryDate || 'Loading...'}`, icon: Icons.Package, color: "bg-gray-100 text-gray-600" },
                    { id: 'stock_change', title: 'Stock Change Report', sub: `Purchases valued at ${inventoryData.gfaSetting ? 'Cost' : 'Selling'} Price`, icon: Icons.CreditCard, color: "bg-pink-100 text-pink-600" },
                    { 
                        id: 'empty_bottles', 
                        title: 'Empty Bottle Tracking', 
                        sub: `Total: ${formatTotalUnits(totalEmptiesUnits)} units`, 
                        icon: Icons.AlertCircle, 
                        color: "bg-cyan-100 text-cyan-600" 
                    },
                ],
            }), [inventoryData.inventoryDate, inventoryData.gfaSetting, totalEmptiesUnits, inventoryData]); 

            const openReport = (id, title) => {
                if (!isReady) return; 
                setCurrentReport({ id, title });
                setModalOpen(true);
            };

            useEffect(() => {
                setSelectedCategory('Inventory');
            }, []);
            
            const categoryData = categories[selectedCategory];

          

            if (error) {
                 return (
                    <div className="min-h-screen flex items-center justify-center bg-red-50 p-6">
                        <div className="text-center p-6 bg-white rounded-xl shadow border border-red-200">
                            <Icons.AlertCircle size={32} className="text-red-500 mx-auto mb-3" />
                            <p className="text-red-800 font-semibold">Data Error</p>
                            <p className="text-sm text-red-600 mt-1">{error}</p>
                            <p className="text-xs text-red-400 mt-3">Please ensure local storage keys are set and Firebase rules allow access.</p>
                        </div>
                    </div>
                );
            }


            return (
                <div className="min-h-screen flex justify-center">
                    <div className="w-full max-w-lg bg-white min-h-screen shadow-2xl relative flex flex-col">
                        
                        <div className="sticky top-0 z-30 bg-[#3f72af] backdrop-blur-md border-b border-[#5698d8]">
    <div className="h-2 w-full"></div>
    
    <div className="px-5 py-3">
        <div className="flex justify-between items-center mb-4">
            <h1 className="text-2xl font-black tracking-tight text-white"> 
                 <a onClick={() => window.history.back()}>
                    <i class="fas fa-chevron-left"></i> </a>Avanti
                    <span className="text-blue-300">.ledger</span>
                
            </h1>
            <div className="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center border border-white/20">
                <span className="font-bold text-xs text-blue-300">AV</span>
            </div>
        </div>

        <div className="flex p-1 bg-[#2b598b] rounded-lg overflow-x-auto no-scrollbar">
 <a href="accounting-report.html" className="flex-1 text-center py-1.5 px-3 rounded-md text-xs font-bold transition-all whitespace-nowrap text-gray-300 cursor-not-allowed hover:text-white">
           
                Accounting
            </a>
            <a href="sales-report.html" className="flex-1 text-center py-1.5 px-3 rounded-md text-xs font-bold transition-all whitespace-nowrap text-gray-300 cursor-not-allowed hover:text-white">
                Sales
            </a>
            <a className="flex-1 text-center py-1.5 px-3 rounded-md text-xs font-bold transition-all whitespace-nowrap bg-[#3f72af] text-white shadow-lg">
                Inventory
            </a>
        </div>
    </div>
   
</div>
<nav
  className="fixed bottom-0 left-0 w-full h-[70px]
             bg-white/85 backdrop-blur-[20px]
             border-t border-black/5
             flex items-center justify-around
             z-10
             pb-[env(safe-area-inset-bottom)]
             font-['Inter',sans-serif]"
>
  {/* Home */}
  <a
    href="dashboard.html"
    className="flex flex-col items-center flex-1
               text-slate-500 transition duration-200 no-underline"
  >
    <svg className="w-[22px] h-[22px] fill-none stroke-current stroke-2" viewBox="0 0 24 24">
      <rect x="3" y="3" width="7" height="7" />
      <rect x="14" y="3" width="7" height="7" />
      <rect x="14" y="14" width="7" height="7" />
      <rect x="3" y="14" width="7" height="7" />
    </svg>
    <span className="mt-1 text-[11px] font-medium">Home</span>
  </a>

  {/* Inventory (inactive) */}
  <a
    href="inventory.html"
    className="flex flex-col items-center flex-1
               text-slate-500 no-underline"
  >
    <svg className="w-[22px] h-[22px] fill-none stroke-current stroke-2" viewBox="0 0 24 24">
      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
      <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
      <line x1="12" y1="22.08" x2="12" y2="12" />
    </svg>
    <span className="mt-1 text-[11px] font-medium">Inventory</span>
  </a>

  {/* Reports (ACTIVE) */}
  <a
    href="#"
    className="relative flex flex-col items-center flex-1
               text-[#3f72af] no-underline"
  >
    <div
      className="absolute -top-[14px] w-[20px] h-[3px]
                 bg-[#3f72af] rounded-b"
    />

    <svg
      className="w-[22px] h-[22px]
                 fill-blue-600/10 stroke-current stroke-2"
      viewBox="0 0 24 24"
    >
      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
      <polyline points="17 6 23 6 23 12" />
    </svg>
    <span className="mt-1 text-[11px] font-semibold">Reports</span>
  </a>

  {/* Stats */}
  <a
    href="statistics.html"
    className="flex flex-col items-center flex-1
               text-slate-500 no-underline"
  >
    <svg className="w-[22px] h-[22px] fill-none stroke-current stroke-2" viewBox="0 0 24 24">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
      <polyline points="14 2 14 8 20 8" />
      <line x1="16" y1="13" x2="8" y2="13" />
      <line x1="16" y1="17" x2="8" y2="17" />
    </svg>
    <span className="mt-1 text-[11px] font-medium">Stats</span>
  </a>

  {/* Settings */}
  <a
    href="settings.html"
    className="flex flex-col items-center flex-1
               text-slate-500 no-underline"
  >
    <svg className="w-[22px] h-[22px] fill-none stroke-current stroke-2" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="3" />
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0 .33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
    </svg>
    <span className="mt-1 text-[11px] font-medium">Settings</span>
  </a>
</nav>
                        {/* Scrollable Main Content */}
                        <div className="flex-1 overflow-y-auto pb-24 px-5 pt-4">
                            
                            {/* Contextual Header */}
                            <div className="mb-6 animate-fade-in">
                                <h2 className="text-3xl font-bold text-gray-900 mb-1">Inventory Reports</h2>
                                <p className="text-gray-400 text-sm">
                                    {categoryData ? `${categoryData.length} reports available` : 'Select a report to begin'}
                                </p>
                            </div>

                            {/* Featured Summary Card (Inventory - Quantity Focus) */}
                            <div className="mb-8 animate-fade-in" style={{animationDelay: '0.1s'}}>
                                <Card className="p-5 bg-gradient-to-r from-gray-900 to-black text-white shadow-lg border-none">
                                    <div className="flex justify-between items-center mb-2">
                                        <p className="text-gray-400 text-xs font-bold uppercase">Expected Return on Inventory</p>
                                        <Icons.TrendingUp size={20} className="text-green-400"/>
                                    </div>
                                    <h3 className="text-4xl font-extrabold mb-1">{formatCurrency(totalExpectedRevenue)}</h3>
                                    <p className="text-gray-400 text-xs mt-2">Valuation as at {inventoryData.inventoryDate}</p>
                                    
                                    <div className="grid grid-cols-3 gap-4 pt-4 border-t border-gray-700 mt-4">
                                        <div className="text-center">
                                            <span className="block text-xl font-bold text-white">{formatTotalUnits(totalStockUnits)}</span>
                                            <span className="text-[10px] text-gray-400 uppercase">Total Units</span>
                                        </div>
                                        <div className="text-center">
                                            <span className="block text-xl font-bold text-yellow-400">{highestContributor.quantity}</span>
                                            <span className="text-[10px] text-gray-400 uppercase leading-tight">Highest Qty: <span className="font-semibold truncate">{highestContributor.name}</span></span>
                                        </div>
                                        <div className="text-center">
                                            <span className="block text-xl font-bold text-red-400">{formatTotalUnits(totalEmptiesUnits)}</span>
                                            <span className="text-[10px] text-gray-400 uppercase">Total Empties</span>
                                        </div>
                                    </div>
                                </Card>
                            </div>

                            {/* Report List - Now includes icons */}
                            <div className="space-y-4 animate-fade-in" style={{animationDelay: '0.2s'}}>
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Reports</h3>
                                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                                    {categoryData && categoryData.map((report, index) => (
                                        <ListItem 
                                            key={report.id}
                                            title={report.title}
                                            sub={report.sub}
                                            icon={report.icon} 
                                            color={report.color} 
                                            isLast={index === categoryData.length - 1}
                                            onClick={() => openReport(report.id, report.title)} 
                                        />
                                    ))}
                                </div>
                            </div>
                            
                            {/* Example Promo / Tip */}
                            <div className="mt-8 p-4 bg-yellow-50 rounded-2xl border border-yellow-100 flex gap-3 items-start animate-fade-in" style={{animationDelay: '0.3s'}}>
                                <div className="p-2 bg-yellow-100 rounded-full text-yellow-600">
                                    <Icons.Sparkles size={16} />
                                </div>
                                <div>
                                    <h4 className="text-sm font-bold text-yellow-800">Pro Tip</h4>
                                    <p className="text-xs text-yellow-700 mt-1">Review your inventory metrics focusing on **quantity** to ensure physical stock matches records.</p>
                                </div>
                            </div>

                        </div>

                        {/* Modal for Reports */}
                        <ReportModal 
                            isOpen={modalOpen} 
                            onClose={() => setModalOpen(false)} 
                            title={currentReport?.title || 'Report'}
                        >
                            {currentReport && <ReportContent reportId={currentReport.id} data={inventoryData} />}
                        </ReportModal>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AvantiLedger />);
    </script>
</body>
</html>
