<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.95 , maximum-scale=0.95, user-scalable=no">
    <title>Change Password - iOS 18</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3f72af">

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js")
        .then(reg => console.log("Service worker registered:", reg))
        .catch(err => console.error("Service worker error:", err));
    });
  }
</script>

    <style>
        :root{
            --system-blue: #007AFF;
            --system-red: #FF3B30;
            --border-color: #E5E5E5;
            --text-color: #000000;
        }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
            background: linear-gradient(180deg,#f2f6fb 0%, #eef2f7 100%);
            margin-top: 70px;
overflow: hidden;
        }
        .header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:25px 0px 10px 12px;
            background: #3f72af;
            border-bottom:1px solid var(--border-color);
            position:fixed; top:0; z-index:10;
            width:100%;
        }
        .ios-input {
            background:white;
            border:1px solid #d9d9d9;
            border-radius:18px;
            transition:0.25s ease;
        }
        .ios-input:focus {
            border-color:#007aff;
            box-shadow:0 0 0 4px rgba(0,122,255,0.15);
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header mb-4">
        <a href="" onclick="history.back(); return false;" class="text-blue-300">
            <i class="fas fa-chevron-left"></i> Settings
        </a>
        <div class="header-title font-semibold text-lg -ml-12 text-white">Change Password</div>
        <div style="width:36px;"></div>
    </div>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet">

<nav style="
    position: fixed; 
    bottom: 0; 
    left: 0; 
    width: 100%; 
    height: 70px; 
    background: rgba(255, 255, 255, 0.85); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-top: 1px solid rgba(0, 0, 0, 0.05); 
    display: flex; 
    justify-content: space-around; 
    align-items: center; 
    z-index: 9999; 
    height: 97px; 
    padding-bottom: 25px;
    font-family: 'Inter', sans-serif;
">
    
    <a href="/dashboard.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1; transition: 0.2s;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Home</span>
    </a>

    <a href="/inventory.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1; position: relative;">
       
        
        <svg style="width: 22px; height: 22px; fill: white; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 600;">Inventory</span>
    </a>

    <a href="/accounting-report.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Reports</span>
    </a>

    <a href="/statistics.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Stats</span>
    </a>

    <a href="/settings.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #3f72af; flex: 1; position: relative;">
  <div style="position: absolute; top: -14px; width: 20px; height: 3px; background: #3f72af; border-radius: 0 0 4px 4px;"></div>
        <svg style="width: 22px; height: 22px; fill: rgba(37, 99, 235, 0.1); stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0 .33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Settings</span>
    </a>
</nav>


    <!-- MAIN CONTENT -->
    <div class="px-5 mt-5 space-y-6">

        <p class="text-[14px] text-gray-700 leading-relaxed">
            Your password must be at least <b>6 characters</b> and contain letters, numbers and special characters.
        </p>

        <div class="space-y-4">
            <input id="currentPw" type="password" placeholder="Current Password"
                class="ios-input w-full px-4 py-4 text-[16px] outline-none"/>

            <input id="newPw" type="password" placeholder="New Password"
                class="ios-input w-full px-4 py-4 text-[16px] outline-none"/>

            <input id="rePw" type="password" placeholder="Retype New Password"
                class="ios-input w-full px-4 py-4 text-[16px] outline-none"/>
        </div>

        <label class="flex items-center space-x-3 text-[15px] text-gray-800">
            <input id="log-out" type="checkbox" checked class="w-5 h-5 rounded border-gray-400">
            <span>Log out all other devices</span>
        </label>

        <button id="changeBtn"
            class="w-full bg-blue-500 text-white py-4 rounded-2xl text-[16px] font-medium shadow-lg active:scale-[0.98] transition">
            Change Password
        </button>

    </div>


<!-- FIREBASE + JS -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// ------------------ Firebase Config ------------------
const firebaseConfig = {
    apiKey: "AIzaSyAw7L6TJtF1W0PwfStEJUC4CebUyMdQU9w",
    authDomain: "users-66be4.firebaseapp.com",
    databaseURL: "https://users-66be4-default-rtdb.firebaseio.com",
    projectId: "users-66be4",
    storageBucket: "users-66be4.appspot.com",
    messagingSenderId: "685869384220",
    appId: "1:685869384220:web:4f921bbf409775ea8ec3ac"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

// ------------------ LocalStorage Credentials ------------------
const accountKey = localStorage.getItem("AV_ledger_account_key");
const authStatus = localStorage.getItem("AV_ledger_auth_status");

// Access control
if (!accountKey || !authStatus) {
    alert("Missing credentials. Please log in again.");
    window.location.href = "/index.html";
}

if (authStatus.toLowerCase() === "standard") {
    document.body.innerHTML = `
        <div class='p-6 text-center text-lg'>
            <p class='text-red-600 font-semibold mb-4'>
                Standard profiles cannot change the password.
            </p>
            <button onclick="history.back()" 
                class="bg-blue-500 text-white px-4 py-2 rounded-xl">
                Go Back
            </button>
        </div>`;
}

let accountEmail = "";

// ------------------ Get Email ------------------
db.ref("accounts/" + accountKey + "/email").once("value")
.then(snap => {
    if (snap.exists()) accountEmail = snap.val();
    else alert("Email not found.");
});

// ------------------ Change Password Logic ------------------
document.getElementById("changeBtn").addEventListener("click", async () => {

    const currentPw = document.getElementById("currentPw").value.trim();
    const newPw = document.getElementById("newPw").value.trim();
    const rePw = document.getElementById("rePw").value.trim();
    const logoutOther = document.getElementById("log-out").checked;

    if (!currentPw || !newPw || !rePw) {
        alert("Fill in all fields.");
        return;
    }
    if (newPw !== rePw) {
        alert("New passwords do not match.");
        return;
    }
    if (newPw.length < 6) {
        alert("New password must be at least 6 characters.");
        return;
    }

    try {
        // Login using current password
        const login = await auth.signInWithEmailAndPassword(accountEmail, currentPw);
        const user = login.user;

        await user.updatePassword(newPw);

        // ------------------ REDIRECT FIX APPLIED HERE ------------------
        if (logoutOther) {
            await auth.signOut();
            alert("Password changed successfully. Logged out on all devices.");
            window.location.href = "/manage-devices.html";   // <-- FIX
            return;
        }

        alert("Password changed successfully!");

    } catch (err) {
        console.error(err);

        if (err.code === "auth/wrong-password")
            alert("Current password is incorrect.");
        else if (err.code === "auth/user-not-found")
            alert("User not found.");
        else
            alert("Error: " + err.message);
    }
});
</script>

</body>
</html>