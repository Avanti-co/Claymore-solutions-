<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.94, minimum-scale=0.94 ,viewport-fit=cover, maximum-scale=0.94, user-scalable=no">
    <title>Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3f72af">

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js")
        .then(reg => console.log("Service worker registered:", reg))
        .catch(err => console.error("Service worker error:", err));
    });
  }
</script>

    <style>
        :root{
            --card-bg: rgba(255,255,255,0.9);
            --muted: #3f72af;
            --accent: #0ea5a4; /* teal-ish */
            --system-blue: #007AFF;
            --system-green: #34c759;
            --system-red: #FF3B30;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --border-color: #E5E5E5;
            --text-color: #3f72af;
            --muted-color: #3f72af;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #F2F2F7; 
            padding-top: 70px;
padding-bottom: 70px;
        }
     .header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:20px 0px 12px 16px;
            background: #3f72af; 
    backdrop-filter: blur(200px); 
    -webkit-backdrop-filter: blur(20px); 
    border-top: 1px solid rgba(0, 0, 0, 0.05); 
            border-bottom:1px solid var(--border-color);
            position:fixed; top:0; z-index:10;
            width: 100%;
        }
        .header a{
            color:#a3c9f1;
            text-decoration:none;
            font-size:1.1rem;
            font-weight:500;
            text-align: left;
        }
        .header-title{
            font-weight:600;
            font-size:1.2rem;
            text-align:center;
            flex:1;
            color: white;
            margin-left: -30px;
        }

        .ios-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
border: 1px solid #e5e5ea;
        }
        .ios-list-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5ea;
        }
        .ios-list-item:last-child {
            border-bottom: none;
        }

        /* PROFESSIONAL TAB NAVIGATION (Segmented Control) */
        .segmented {
            display: flex;
            background: #e5e5ea; /* Light gray background */
            padding: 3px;
            border-radius: 9px; /* Smoother corners */
            box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.05);
        }
        .segmented button {
            flex: 1;
            padding: 6px 10px;
            border-radius: 7px;
            border: none;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-color);
            background: transparent;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .segmented .active {
            background: var(--card); /* White foreground */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle 3D lift */
            font-weight: 600;
        }

        /* Custom styles for the iOS-style switch/toggle */
        .toggle-switch-input:checked + .toggle-switch-base {
            background-color: var(--system-green);
        }
        .toggle-switch-input:checked ~ .toggle-switch-dot {
            transform: translateX(100%);
        }

        /* Custom black gradient for the summary card (from previous revision) */
        .black-gradient-card {
            background: linear-gradient(135deg, black, black);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 0; 
        }
        .black-gradient-card p {
            color: rgba(255, 255, 255, 0.8);
        }
        .black-gradient-card .amount-emphasis {
            font-size: 1.8rem; 
            font-weight: 800; 
            color: #ffffff;
            line-height: 1.1;
        }
        .black-gradient-card .small-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        .black-gradient-card .small-label i {
            margin-right: 6px;
            font-size: 0.9rem;
        }
        
        .hidden { display: none !important; }
        .muted { color: #6b7280; }
        
        .ios-search-bar {
            background-color: white;
            padding: 10px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .ios-search-bar input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 2px;
            font-size: 1rem;
            background: transparent;
        }
    </style>
</head>

<body>

  <div class="header">
    <a href="" onclick="history.back(); return false;"><i class="fas fa-chevron-left"></i> Back</a>
    <div class="header-title" id="header-title">Inventory</div>
    <div style="width:36px;"></div>
  </div>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet">

<nav style="
    position: fixed; 
    bottom: 0; 
    left: 0; 
    width: 100%; 
    
    background: rgba(255, 255, 255, 0.85); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-top: 1px solid rgba(0, 0, 0, 0.05); 
    display: flex; 
    justify-content: space-around; 
    align-items: center; 
    z-index: 10; 
    padding-top: 14px; 
    padding-bottom: constant(safe-area-inset-bottom, 25px);
padding-bottom: env(safe-area-inset-bottom, 25px);
   
    font-family: 'Inter', sans-serif;
">
    
    <a href="dashboard.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1; transition: 0.2s;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Home</span>
    </a>

    <a href="#" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #3f72af; flex: 1; position: relative;">
        <div style="position: absolute; top: -14px; width: 20px; height: 3px; background: #3f72af; border-radius: 0 0 4px 4px;"></div>
        
        <svg style="width: 22px; height: 22px; fill: rgba(37, 99, 235, 0.1); stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 600;">Inventory</span>
    </a>

    <a href="accounting-report.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Reports</span>
    </a>

    <a href="statistics.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Stats</span>
    </a>

    <a href="settings.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0 .33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Settings</span>
    </a>
</nav>

 
  <div class="p-2 " style="overflow: hidden; max-width: 99vw;">
    <div class="max-w-md mx-auto">

<div class="ios-card p-2 mb-3">

      <div class="mb-4">
        <div class="segmented">
            <button id="tab-inventory" class="active"><i class="fas fa-boxes mr-1"></i> Inventory</button>
            <button id="tab-empties"><i class="fas fa-trash-restore mr-1"></i> Empties</button>
        </div>
      </div>

            <div class="ios-list-item flex justify-between items-center p-1">
                <p class="font-medium text-gray-700 text-sm"><i class="fas fa-clock mr-2 text-blue-500"></i>Use Yesterday's Closing</p>
                <label for="toggle-yesterday-closing" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="toggle-yesterday-closing" class="sr-only toggle-switch-input">
                        <div class="block bg-gray-300 w-10 h-6 rounded-full toggle-switch-base"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform duration-300 toggle-switch-dot"></div>
                    </div>
                </label>
            </div>
        

     <div id="summary-card" 
     class="p-5 bg-gradient-to-br from-[#3f72af] to-indigo-800 text-white shadow-lg border-none flex flex-col justify-between h-56 rounded-xl hover:shadow-2xl transition duration-300 mt-3 mb-3">

    <div class="flex justify-between items-start">
        <div>
            <p class="text-indigo-200 text-sm font-bold uppercase tracking-wider">Inventory & Stock Status</p>
            
            <h3 class="text-3xl font-extrabold mt-2 mb-1" id="total-value">K0</h3>
            <p class="text-xs text-indigo-200">Total Value (at Selling Price)</p>
        </div>
        
        <i class="fas fa-cubes text-indigo-300 opacity-80 text-3xl"></i>
    </div>
    
    <div class="pt-3 border-t border-blue-400 space-y-2">
        
        <div class="flex justify-between items-center">
            <span class="text-sm font-semibold text-white"><i class="fas fa-boxes mr-2"></i>Total Units in Stock</span>
            <span class="text-lg font-bold text-white" id="total-inventory">0 units</span>
        </div>
        
        <div class="flex justify-between items-center">
            <span class="text-sm font-semibold text-indigo-200"><i class="fas fa-recycle mr-2"></i>Total Empty Bottles</span>
            <span class="text-lg font-bold text-yellow-300" id="total-empties">0 bottles</span>
        </div>
        
       
    </div>
</div></div></div>


      <div id="screen-inventory">
       

        <div class="ios-search-bar" style="border: solid lightgray 1px;">
            <i class="fas fa-search text-gray-500 text-sm mr-2"></i>
            <input type="text" id="inventory-search-input" placeholder="Search Inventory" class="text-gray-800">
        </div>

        <div class="ios-card mb-6">
            <div class="ios-list-item text-sm bg-gray-50 rounded-t-xl">
                <p class="font-semibold text-gray-600"><i class="fas fa-calendar-alt mr-2"></i>Inventory as at <span id="inventory-date">...</span></p>
            </div>
            <ul id="inventory-list"></ul>
        </div>
      </div>

      <div id="screen-empties" class="hidden">
        <div class="ios-search-bar">
            <i class="fas fa-search text-gray-500 text-sm mr-2"></i>
            <input type="text" id="empties-search-input" placeholder="Search Empties" class="text-gray-800">
        </div>

        <div class="ios-card mb-6">
            <div class="ios-list-item text-sm bg-gray-50 rounded-t-xl">
                <p class="font-semibold text-[#3f72af]"><i class="fas fa-trash-restore mr-2"></i>Empty Bottles Tracking</p>
            </div>
            <ul id="empties-list"></ul>
        </div>
      </div>

      <div class="p-4">
        <button id="generate-reports-btn" class="w-full py-3 bg-[#3f72af] text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150" onclick="window.location='accounting-report.html'"
>
            Generate reports
        </button>
      </div>

    </div>
  </div> 
    
  <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm z-50 hidden flex justify-center items-end sm:items-center" >
      <div class="bg-white w-full max-w-md sm:rounded-xl transform transition-all duration-300 translate-y-full sm:translate-y-0" id="modal-content" style="border-radius: 20px 20px 0 0; z-index: 1000;">
          <div class="p-4 border-b border-gray-200 relative bg-[#3f72af]" style=" border-top-left-radius: 20px; border-top-right-radius: 20px;">
              <h2 id="modal-item-name" class="text-xl font-semibold text-center" style="color: white;">Item Name</h2>
              <button id="close-modal-btn" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-white" >
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" style="color: white;"></path></svg>
              </button>
          </div>

          <div class="p-4">
              <div class="ios-card p-3 mb-4">
                  <p class="text-2xl font-bold text-[#3f72af] mb-2" id="modal-available-units">0 units available</p>
                  <div class="flex justify-between items-center text-sm mb-1">
                      <p class="text-gray-700"><i class="fas fa-tag mr-2"></i>Selling price:</p>
                      <p class="font-medium text-grey-600" id="modal-selling-price">K0 per unit</p>
                  </div>
                  <div class="flex justify-between items-center text-sm">
                      <p class="text-gray-700"><i class="fas fa-chart-line mr-2"></i>Valued at:</p>
                      <p class="font-medium text-grey-600" id="modal-valued-at">K0 at selling price</p>
                  </div>
              </div>

              <div class="ios-card p-4 mb-6">
                  <p class="font-semibold mb-3 text-[#3f72af]"><i class="fas fa-recycle mr-2"></i>Empty Bottle Counting</p>
                  <div class="flex justify-between items-center mb-4">
                      <p class="text-sm text-gray-900">Track Empty Bottles</p>
                      <label for="toggle-empty-bottles" class="flex items-center cursor-pointer">
                          <div class="relative">
                              <input type="checkbox" id="toggle-empty-bottles" class="sr-only toggle-switch-input">
                              <div class="block bg-gray-300 w-10 h-6 rounded-full toggle-switch-base"></div>
                              <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform duration-300 toggle-switch-dot"></div>
                          </div>
                      </label>
                  </div>

                  <div id="empties-input-container">
                      <div class="flex justify-between items-center py-2 border-t border-gray-100">
                          <p class="text-sm text-gray-700">Calculated Empties as at <span id="empties-end-date">...</span></p>
                          <input type="number" id="current-empties-input" value="0" min="0" class="text-lg font-bold w-16 text-right border-b focus:border-blue-500 outline-none p-1" disabled>
                      </div>
                       <div class="text-xs text-gray-500  ">Formula: Initial Count + Î£(Sales - Orders)</div>
                      <div class="flex justify-between items-center py-2 border-t border-gray-100 mt-2">
                            <p class="text-sm text-gray-700">Initial Empties as at <span id="empties-start-date1"></span></p>
                            <input type="number" id="initial-empties-input" value="0" min="0" class="text-lg font-bold w-16 text-right border-b focus:border-blue-500 outline-none p-1">
                      </div>
                      
                     
                      <p id="empties-formula-note" class="text-xs text-red-500 mt-2 hidden">Tracking starts from <span id="empties-start-date"></span></p>
                  </div>
              </div>

              <div class="ios-card p-4">
                  <p class="font-semibold mb-3 text-[#3f72af]"><i class="fas fa-chart-bar mr-2"></i>WEEKLY STOCK CHANGE SUMMARY</p>
                <div
  id="stock-carousel-track"
  style="
    display: flex;
    gap: 12px;
    padding-bottom: 8px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  "
>
  <div
    style="
      min-width: 220px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      text-align: center;
      font-size: 12px;
      scroll-snap-align: start;
      flex-shrink: 0;
    "
  >
    <p style="color: #6b7280;">No data available for the week.</p>
  </div>

  <!-- Example extra slides (optional) -->
  <div
    style="
      min-width: 220px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      text-align: center;
      font-size: 12px;
      scroll-snap-align: start;
      flex-shrink: 0;
    "
  >
    <p style="color: #6b7280;">Awaiting next update</p>
  </div>
</div>
              </div>
          </div>
      </div>
  </div>

<script>
// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
    authDomain: "users-66be4.firebaseapp.com",
    databaseURL: "https://users-66be4-default-rtdb.firebaseio.com",
    projectId: "users-66be4",
    storageBucket: "users-66be4.firebasestorage.app",
    messagingSenderId: "776585122050",
    appId: "1:776585122050:web:3f452a1f16dc36ee1ef21b",
    measurementId: "G-ZS8W4BBGD5"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// --- STATE MANAGEMENT ---
let inventoryData = [];
let emptiesData = [];
let fullStatsData = {};
let datesKeys = [];
let currentSelectedItem = null;

const today = new Date().toISOString().split('T')[0];
const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);
const yesterdayStr = yesterday.toISOString().split('T')[0];

// --- DOM ELEMENTS ---
const inventoryList = document.getElementById('inventory-list');
const emptiesList = document.getElementById('empties-list');
const totalValueEl = document.getElementById('total-value');
const totalInventoryEl = document.getElementById('total-inventory');
const totalEmptiesEl = document.getElementById('total-empties');
const inventoryDateEl = document.getElementById('inventory-date');
const yesterdayToggle = document.getElementById('toggle-yesterday-closing');

const formatCurrency = (num) => `K${Math.round(num || 0).toLocaleString()}`;

async function getFirebasePaths(accName, user) {
    const syncSnap = await db.ref(`accounts/${accName}/profiles/${user}/syncingWith`).once('value');
    const syncingWith = syncSnap.val();
    let targetUser = user;
    if (syncingWith) {
        targetUser = Object.keys(syncingWith).find(key => syncingWith[key] === true) || user;
    }
    const syncAllSnap = await db.ref(`accounts/${accName}/settings/synchronization`).once('value');
    const isGlobal = syncAllSnap.val() === 'all';
    const basePath = isGlobal ? `accounts/${accName}/global_ledger` : `accounts/${accName}/profiles/${targetUser}`;
    return { basePath, targetUser };
}

// --- CORE DATA FETCHING ---
async function fetchData() {
    const accName = localStorage.getItem('AV_ledger_account_key');
    const user = localStorage.getItem('AV_ledger_username');
    if (!accName || !user) return;

    const { basePath } = await getFirebasePaths(accName, user);
    
    db.ref(`${basePath}`).on('value', (snapshot) => {
        const data = snapshot.val() || {};
        fullStatsData = data.avanti_stats?.dates || {};
        const emptiesRaw = data.empties_tracking || {};
        datesKeys = Object.keys(fullStatsData).sort();

        const allHistoricalItemIds = new Set();
        Object.values(fullStatsData).forEach(dateObj => {
            if (dateObj.items) Object.keys(dateObj.items).forEach(id => allHistoricalItemIds.add(id));
        });

        const cleanupUpdates = {};
        emptiesData = [];

        for (const [id, e] of Object.entries(emptiesRaw)) {
            if (!allHistoricalItemIds.has(id)) {
                cleanupUpdates[`${basePath}/empties_tracking/${id}`] = null;
                continue;
            }

            let count = e.initialCount || 0;
            datesKeys.forEach(dk => {
    if (dk >= e.startDate && dk <= yesterdayStr) {
        const day = fullStatsData[dk]?.items?.[id];
        if (day) {
            const sales = (day.opening || 0) + (day.orders || 0) - (day.closing || 0);
            count += (sales - (day.orders || 0));
        }
    }
});

            const name = Object.values(fullStatsData).reverse()
                .find(d => d.items?.[id])?.items[id].name || "Unknown";

            emptiesData.push({ id, name, units: Math.max(0, count), startDate: e.startDate, initial: e.initialCount });
        }

        if (Object.keys(cleanupUpdates).length > 0) db.ref().update(cleanupUpdates);

        const sourceDate = yesterdayToggle.checked ? yesterdayStr : (datesKeys.findLast(k => fullStatsData[k].balanced) || today);
        const dayData = fullStatsData[sourceDate]?.items || {};
        inventoryData = Object.entries(dayData).map(([id, item]) => ({
            id, name: item.name, stock: item.closing || 0, price: item.price || 0
        }));

        renderUI(sourceDate);
        
        if (currentSelectedItem) {
            renderStockChangeCarousel(currentSelectedItem.id);
        } else {
            renderStockChangeCarousel(null);
        }
    });
}

// --- WEEKLY STOCK CAROUSEL (Individual Days Sun - Sat) ---
function renderStockChangeCarousel(activeItemId = null) {
    const carouselTrack = document.getElementById('stock-carousel-track');
    if (!carouselTrack) return;

    if (!activeItemId) {
        carouselTrack.innerHTML = `<p class="text-gray-400 text-[10px] italic p-4 text-center w-full">Select an item to see weekly movement</p>`;
        return;
    }

    const now = new Date();
    const sun = new Date(now);
    sun.setDate(now.getDate() - now.getDay());
    sun.setHours(0, 0, 0, 0);

    const sat = new Date(sun);
    sat.setDate(sun.getDate() + 6);
    sat.setHours(23, 59, 59, 999);

    const sunStr = sun.toISOString().split('T')[0];
    const satStr = sat.toISOString().split('T')[0];

    let changeCards = [];

    // Process each date individually instead of totaling
    datesKeys.forEach(date => {
        if (date >= sunStr && date <= satStr) {
            const items = fullStatsData[date]?.items || {};
            const item = items[activeItemId];
            
            if (item) {
                const sales = (item.opening || 0) + (item.orders || 0) - (item.closing || 0);
                const orders = (item.orders || 0);

                // Add card for Purchase on this day
                if (orders > 0) {
                    changeCards.push(`
                        <div class="carousel-card bg-blue-50 border-blue-100 border p-3 rounded-xl min-w-[130px] snap-center">
                            <p class="text-[9px] font-bold text-blue-600 uppercase">Purchased</p>
                            <p class="text-xs font-semibold truncate">${item.name}</p>
                            <p class="text-lg font-black text-blue-700">+${orders}</p>
                            <p class="text-[8px] text-gray-400">${date}</p>
                        </div>
                    `);
                }
                // Add card for Sales on this day
                if (sales > 0) {
                    changeCards.push(`
                        <div class="carousel-card bg-orange-50 border-orange-100 border p-3 rounded-xl min-w-[130px] snap-center">
                            <p class="text-[9px] font-bold text-orange-600 uppercase">Sold</p>
                            <p class="text-xs font-semibold truncate">${item.name}</p>
                            <p class="text-lg font-black text-orange-700">-${sales}</p>
                            <p class="text-[8px] text-gray-400">${date}</p>
                        </div>
                    `);
                }
            }
        }
    });

    // Reverse so the most recent day of the week shows first in the carousel
    carouselTrack.innerHTML = changeCards.length > 0 ? changeCards.reverse().join('') : 
        `<p class="text-gray-400 text-[10px] italic p-4 text-center w-full">No activity this week</p>`;
}

function renderUI(date) {
    inventoryDateEl.textContent = date || 'N/A';
    const totalVal = inventoryData.reduce((sum, i) => sum + (i.stock * i.price), 0);
    const totalStock = inventoryData.reduce((sum, i) => sum + i.stock, 0);
    const totalEmptiesCount = emptiesData.reduce((sum, e) => sum + e.units, 0);

    totalValueEl.textContent = formatCurrency(totalVal);
    totalInventoryEl.textContent = `${totalStock.toLocaleString()} units`;
    totalEmptiesEl.textContent = `${totalEmptiesCount.toLocaleString()} bottles`;

    renderInventoryList(inventoryData);
    renderEmptiesList(emptiesData);
}

function renderInventoryList(data) {
    inventoryList.innerHTML = data.map(item => `
        <li class="ios-list-item flex justify-between items-center active:bg-gray-100 cursor-pointer" onclick="openItemModal('${item.id}')">
            <div>
                <p class="font-semibold text-gray-800 text-sm"><i class="fas fa-box-open" style="color: #3f72af"></i> ${item.name}</p>
                <p class="text-[11px] text-gray-500">selling at ${formatCurrency(item.price)}</p>
            </div>
            <div class="flex items-center">
                <div class="text-right mr-3">
                    <p class="font-bold text-lg">${item.stock}</p>
                    <p class="text-[9px] uppercase text-gray-400">Units</p>
                </div>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
        </li>
    `).join('');
}

function renderEmptiesList(data) {
    emptiesList.innerHTML = data.map(item => `
        <li class="ios-list-item flex justify-between items-center active:bg-gray-100 cursor-pointer" onclick="openItemModal('${item.id}')">
            <p class="font-medium text-gray-800 text-sm"><i class="fas fa-wine-bottle" style="color: #3f72af"></i> ${item.name}</p>
            <div class="flex items-center">
                <span class="font-bold text-gray-700 mr-3">${item.units}</span>
                <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
            </div>
        </li>
    `).join('');
}

// --- MODAL LOGIC WITH INSTANT TOGGLE CALCULATION ---
window.openItemModal = function(id) {
    const item = inventoryData.find(i => i.id === id);
    const empty = emptiesData.find(e => e.id === id);
    if (!item) return;

    currentSelectedItem = item;
    renderStockChangeCarousel(id); 
    
    document.getElementById('modal-item-name').textContent = item.name;
    document.getElementById('modal-available-units').textContent = `${item.stock} units available`;
    document.getElementById('modal-selling-price').textContent = `${formatCurrency(item.price)} per unit`;
    document.getElementById('modal-valued-at').textContent = `${formatCurrency(item.stock * item.price)} at selling price`;
    document.getElementById('empties-end-date').textContent = yesterdayStr;

    const toggle = document.getElementById('toggle-empty-bottles');
    const initialInput = document.getElementById('initial-empties-input');
    const currentInput = document.getElementById('current-empties-input');
    const startSpan = document.getElementById('empties-start-date1');

    if (empty) {
        toggle.checked = true;
        initialInput.value = empty.initial;
        currentInput.value = empty.units;
        startSpan.textContent = empty.startDate;
    } else {
        toggle.checked = false;
        initialInput.value = 0;
        currentInput.value = 0;
        startSpan.textContent = "Not Tracking";
    }

    const calculateLocalEmpties = (initialVal, startDate) => {
    let count = initialVal;
    datesKeys.forEach(dk => {
        if (dk >= startDate && dk <= yesterdayStr) {
            const day = fullStatsData[dk]?.items?.[id];
            if (day) {
                const sales = (day.opening || 0) + (day.orders || 0) - (day.closing || 0);
                count += (sales - (day.orders || 0));
            }
        }
    });
    return Math.max(0, count);
};

    toggle.onchange = async (e) => {
        const accName = localStorage.getItem('AV_ledger_account_key');
        const user = localStorage.getItem('AV_ledger_username');
        const { basePath } = await getFirebasePaths(accName, user);
        const path = `${basePath}/empties_tracking/${id}`;

        if (e.target.checked) {
            const initVal = parseInt(initialInput.value) || 0;
            await db.ref(path).set({ initialCount: initVal, startDate: today });
            startSpan.textContent = today;
            currentInput.value = calculateLocalEmpties(initVal, today);
        } else {
            await db.ref(path).remove();
            startSpan.textContent = "Not Tracking";
            currentInput.value = 0;
            initialInput.value = 0;
        }
        fetchData();
    };

    initialInput.oninput = async (e) => {
        if (!toggle.checked) return;
        const val = parseInt(e.target.value) || 0;
        const accName = localStorage.getItem('AV_ledger_account_key');
        const user = localStorage.getItem('AV_ledger_username');
        const { basePath } = await getFirebasePaths(accName, user);
        
        db.ref(`${basePath}/empties_tracking/${id}/initialCount`).set(val);
        currentInput.value = calculateLocalEmpties(val, startSpan.textContent);
    };

    const modal = document.getElementById('item-modal');
    const content = document.getElementById('modal-content');
    modal.classList.remove('hidden');
    setTimeout(() => content.style.transform = "translateY(0)", 10);
};

document.getElementById('close-modal-btn').onclick = () => {
    const content = document.getElementById('modal-content');
    content.style.transform = "translateY(100%)";
    currentSelectedItem = null;
    renderStockChangeCarousel(null);
    setTimeout(() => document.getElementById('item-modal').classList.add('hidden'), 300);
};

yesterdayToggle.onchange = fetchData;

document.getElementById('tab-inventory').onclick = function() {
    this.classList.add('active');
    document.getElementById('tab-empties').classList.remove('active');
    document.getElementById('screen-inventory').classList.remove('hidden');
    document.getElementById('screen-empties').classList.add('hidden');
    document.getElementById('header-title').textContent = "Inventory";
};

document.getElementById('tab-empties').onclick = function() {
    this.classList.add('active');
    document.getElementById('tab-inventory').classList.remove('active');
    document.getElementById('screen-empties').classList.remove('hidden');
    document.getElementById('screen-inventory').classList.add('hidden');
    document.getElementById('header-title').textContent = "Empties";
};

document.getElementById('inventory-search-input').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = inventoryData.filter(i => i.name.toLowerCase().includes(term));
    renderInventoryList(filtered);
});

document.getElementById('empties-search-input').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = emptiesData.filter(i => i.name.toLowerCase().includes(term));
    renderEmptiesList(filtered);
});

fetchData();
</script>


</body>
</html>
